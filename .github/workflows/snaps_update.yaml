name: 'Snapcraft Update CI'

on:
  # run on main if the file itself was changed
  push:
    branches:
      - main
    paths:
      - '.github/workflows/snaps_update*'
  # run daily on midnight
  schedule:
    - cron: '0 0 * * *'

concurrency:
  # on main, we want all builds to complete even if commits/merging happens faster to make it easier to discover at which point
  # something broke; else, we cancel "old" builds and run/(re)start the build with the latest changes
  group: ${{ github.ref == 'refs/heads/main' && format('ci-main-{0}-{1}', github.workflow, github.sha) || format('ci-{0}-{1}', github.workflow, github.ref) }}

jobs:
  matrix_setup:
    name: 'Setup Build Matrix'
    runs-on: ubuntu-latest

    defaults:
      run:
        shell: bash
        working-directory: './snaps/'

    permissions:
      contents: read

    steps:
      - name: Git - Checkout
        id: git_checkout
        uses: actions/checkout@ec3a7ce113134d7a93b817d10a8272cb61118579 # renovate: tag=v2

      - name: Build Matrix - Setup
        id: set_matrix
        run: |
          echo "::set-output name=matrix::$(python3 -c 'import os, json; print(json.dumps(os.listdir(".")))')"
          echo "::set-output name=snap_working_dir::./snaps"

    outputs:
      matrix: ${{ steps.set_matrix.outputs.matrix }}
      snap_working_dir: ${{ steps.set_matrix.outputs.snap_working_dir }}

  snapcraft_update:
    name: 'Update'
    needs: [matrix_setup]
    runs-on: ubuntu-latest

    strategy:
      matrix:
        package: ${{ fromJson(needs.matrix_setup.outputs.matrix) }}

    defaults:
      run:
        shell: bash

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Git - Checkout
        id: git_checkout
        uses: actions/checkout@ec3a7ce113134d7a93b817d10a8272cb61118579 # renovate: tag=v2

      - name: yq - Setup
        id: yq_setup
        uses: mikefarah/yq@915e9de437b645435e004ef13c5dc347f855658d # renovate: tag=v4.16.2

      - name: Python - Install Dependencies
        id: python_run_pip
        run: |
          python3 -m pip install -r .github/workflows/snaps_update_requirements.pip

      - name: GitHub - Retrieve Data
        id: github_retrieve_data
        run: |
          GIT_REPO_URL="$(yq eval --no-colors --exit-status '.parts.[] | select(.source-type == "git") | .source' snapcraft.yaml)"
          export GIT_REPO_URL
          GIT_ORG="$(python3 -c 'import os; from giturlparse import parse; print(parse(os.getenv("GIT_REPO_URL")).owner)')"
          GIT_REPO="$(python3 -c 'import os; from giturlparse import parse; print(parse(os.getenv("GIT_REPO_URL")).repo)')"

          echo "::set-output name=used_version::$(yq eval --no-colors --exit-status '.version' snapcraft.yaml)"
          echo "::set-output name=source_git_url::$GIT_REPO_URL"
          echo "::set-output name=source_git_org::$GIT_ORG"
          echo "::set-output name=source_git_repo::$GIT_REPO"
        working-directory: ${{ needs.matrix_setup.outputs.snap_working_dir }}/${{ matrix.package }}

      - name: GitHub - Get Latest Release
        id: github_latest_version
        uses: pozetroninc/github-action-get-latest-release@2b51d48e904071035d6632715d41966f516711dd # renovate: tag=v0.5.0
        with:
          owner: ${{ steps.github_retrieve_data.outputs.source_git_org }}
          repo: ${{ steps.github_retrieve_data.outputs.source_git_repo }}
          excludes: prerelease, draft

      - name: GitHub - Evaluate Data
        id: github_evaluate_data
        run: |
          USED_VERSION="${{ steps.github_retrieve_data.outputs.used_version }}"
          LATEST_VERSION="$(python3 -c 'print("${{ steps.github_latest_version.outputs.release }}".lstrip("v"))')"
          echo "Used Version: $USED_VERSION"
          echo "Latest Version: $LATEST_VERSION"

          export USED_VERSION
          export LATEST_VERSION
          SEMVER_COMPARE="$(python3 -c 'import os; import semver; print(semver.compare(os.getenv("USED_VERSION"),os.getenv("LATEST_VERSION")))')"

          # a value of minus one means the first version (parameter) [used version] is lower second version (parameter) [current version] according to semver
          if [[ "$SEMVER_COMPARE" == "-1" ]]; then
            echo "Newer version available, going to update the snapcraft.yaml file to version $LATEST_VERSION and create a PR."
            yq eval --no-colors --exit-status --inplace '.version = "$LATEST_VERSION"' snapcraft.yaml
            git diff | cat # testing
            echo "::set-output name=version_updated::true"
          else
            echo "No newer version available. Will do nothing and stay on version $USED_VERSION"
            echo "::set-output name=version_updated::false"
          fi
        working-directory: ${{ needs.matrix_setup.outputs.snap_working_dir }}/${{ matrix.package }}
