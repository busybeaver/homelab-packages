name: consul-homelab
version: '1.11.5'
summary: HomeLab Consul - Service Mesh for any runtime or cloud
description: HomeLab Consul - Consul automates networking for simple and secure application delivery.
grade: stable
confinement: strict
base: core20
architectures:
  - build-on: [amd64, arm64]
    run-on: [amd64, arm64]
parts:
  consul:
    plugin: go
    go-channel: latest/stable
    source-type: git
    source: https://github.com/hashicorp/consul.git
    source-tag: v$SNAPCRAFT_PROJECT_VERSION
    build-packages:
      - gcc
  consul-wrapper:
    plugin: dump
    source-type: local
    source: ./bin/
    prime:
      # files in the prime phase/area are available in the final snap package
      - daemon.sh
    override-prime: |
      set -x
      snapcraftctl prime
      chmod +x daemon.sh
  build-env:
    plugin: dump
    source-type: local
    source: ./
    stage:
      # files in the stage phase/area are only available during the build of the snap package,
      # but not in the final package itself
      - .ci.env
    override-stage: |
      set -x
      snapcraftctl stage

      CI_ENV_FILE=".ci.env"
      if test -f "$CI_ENV_FILE"; then
        set -a; . "$CI_ENV_FILE"; set +a

        echo "Running on branch: $CI_ENV_GITHUB_REF"
        if [ -n "$CI_ENV_GITHUB_REF" ] && [ "$CI_ENV_GITHUB_REF" != "refs/heads/main" ]; then
          echo "Running on non-default branch, appending the short git rev to the version"
          snapcraftctl set-version "$SNAPCRAFT_PROJECT_VERSION-$(git rev-parse --short HEAD)"
          snapcraftctl set-grade "devel"
        fi
      else
          echo "$CI_ENV_FILE does not exist. Skip setting up properties based on CI environment."
      fi
apps:
  consul-homelab:
    command: bin/consul
    plugs:
      - network
      - network-bind
  daemon:
    # SNAP_DATA is backed up and restored across snap refresh and snap revert operations
    # command: bin/consul agent -config-dir $SNAP_DATA/config/
    # we need to move this to a simple wrapper script, since snapcraft doesn't allow = chars in the command property
    # https://bugs.launchpad.net/snapd/+bug/1820055
    command: daemon.sh
    stop-command: bin/consul leave
    restart-condition: always
    daemon: simple
    # don't start service during the snap installation since it needs some configuration files first
    install-mode: disable
    stop-timeout: 10s
    plugs:
      - network
      - network-bind
