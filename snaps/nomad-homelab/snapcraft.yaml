name: nomad-homelab
version: '1.1.6'
summary: HomeLab - Workload Orchestration Made Easy
description: HomeLab - A simple and flexible workload orchestrator to deploy and manage containers and non-containerized applications across on-prem and clouds at scale.

grade: stable
confinement: strict
base: core20

architectures:
  - build-on: [amd64, arm64]
    run-on: [amd64, arm64]

parts:
  nomad:
    plugin: go
    go-channel: latest/stable
    source-type: git
    source: https://github.com/hashicorp/nomad.git
    source-tag: v$SNAPCRAFT_PROJECT_VERSION
    override-pull: |
      # set -x
      snapcraftctl pull
      printenv
      echo "Running on branch: $GITHUB_REF"
      if ! [ "$GITHUB_REF" = "refs/heads/main" ]; then
        echo "Running on non-default branch, appending the short git rev to the version"
        snapcraftctl set-version "$SNAPCRAFT_PROJECT_VERSION-$(git rev-parse --short HEAD)"
        snapcraftctl set-grade "devel"
      fi
    build-packages:
      - gcc

apps:
  nomad-homelab:
    command: bin/nomad
    plugs:
      - network
      - docker
